<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    
    <style>
            body {
                margin: 0;
                padding: 0;
                overflow: hidden;
            }
	</style>
    <title>LumaSplatviewVR</title>
</head>
<body>
    <div id="loader">
        <h3>Load Content:</h3>
        <input type="text" id="contentID" name="contentID"> 
        <button id="loadContentBtn">Load</button>
    </div>

    <script>
        let inputElt = document.getElementById('contentID');
        let btn = document.getElementById('loadContentBtn');
        btn.disabled=true;

        inputElt.addEventListener("input",function(){
            UpdateButton();
        })

        function UpdateButton(){
            btn.disabled = (inputElt.value === '');
        }

    </script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.157.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.157.0/examples/jsm/",
                "@lumaai/luma-web": "https://unpkg.com/@lumaai/luma-web@0.2.0/dist/library/luma-web.module.js"
            }
        }
    </script>

    <script type="module">
        import { WebGLRenderer, PerspectiveCamera, Scene, Vector3 } from 'three'; 
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import Stats from 'three/addons/libs/stats.module.js'
        import { VRButton } from 'three/addons/webxr/VRButton.js'; 
        import { LumaSplatsThree } from '@lumaai/luma-web'; 
        import { Color, FogExp2 } from "three";
        
        
        document.getElementById("loadContentBtn").addEventListener("click", LoadSplat);
        function LoadSplat() { 
	
            let contentID = document.getElementById("contentID").value; 
            
            document.getElementById("loader").remove();
        
            let renderer = new WebGLRenderer({ antialias: false });
            renderer.xr.enabled = true;
            
            renderer.domElement.style.position = 'absolute';
            renderer.domElement.style.width = '100%';
            renderer.domElement.style.height = '100%';

            document.body.appendChild(renderer.domElement);
            let vrButton = VRButton.createButton(renderer);
            document.body.appendChild(vrButton);
            
            let camera = new PerspectiveCamera(75, 1, 0.1, 1000);
            camera.position.z = 1;   
            
            let controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            const stats = new Stats();
            document.body.appendChild(stats.dom);

            let scene = new Scene();

            let splat = new LumaSplatsThree({ 
                source: 'https://lumalabs.ai/capture/' + contentID,
                //enableThreeShaderIntegration: false,
                //particleRevealEnabled: true,
            });


            splat.position.z = -4;
            splat.position.x = 1; 
            scene.add(splat); 

        function frameLoop() {
            let canvas = renderer.domElement;
            let width = canvas.clientWidth;
            let height = canvas.clientHeight;

			if (canvas.width !== width || canvas.height !== height) {
                    camera.aspect = width / height;
                    camera.updateProjectionMatrix(); 
                    renderer.setSize(width, height, false);
			}

			controls.update();
            stats.update();

			renderer.render(scene, camera);
		}


        var speed = 0.05; 

		document.addEventListener("keydown", onDocumentKeyDown, false);
		function onDocumentKeyDown(event) { 
			var keyCode = event.which;

            var direction = new Vector3();
            camera.getWorldDirection(direction);
            direction.normalize();
            
            console.log(direction);

            var movementVector = new Vector3();

            if (keyCode == 32) { //Space
                speed=0.2
            }


			if (keyCode == 87) { //W 
				movementVector.copy(direction).multiplyScalar(-speed);
			} else if (keyCode == 83) { //S
				movementVector.copy(direction).multiplyScalar(speed);
			}else if (keyCode == 81) { //Q
                movementVector.copy(camera.up).multiplyScalar(-speed);
			}else if (keyCode == 69) { //E
				movementVector.copy(camera.up).multiplyScalar(speed);
			}else if (keyCode == 65) { //A
				movementVector.crossVectors(camera.up, direction).multiplyScalar(-speed);
			} else if (keyCode == 68) { //D
				movementVector.crossVectors(camera.up, direction).multiplyScalar(speed);
			} else if (keyCode == 82) { //R
				splat.position.set(1, 0, -4);
			}
            splat.position.add(movementVector)
		};

        
		renderer.setAnimationLoop(frameLoop); 
		 
	}
    </script>
    
</body>
</html>